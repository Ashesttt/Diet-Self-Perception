<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ user.username }}的饮食记录</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        {% if existing_record %}
        <div class="status-box">
            <p>您今天已经记录过了，请明天再来！</p>
        </div>
        {% else %}
        <div class="button-group">
            <button class="btn btn-red" onclick="submitAndRedirect('eat_much')">吃多了</button>
            <button class="btn btn-green" onclick="submitAndRedirect('not_eat_much')">没吃多</button>
        </div>
        {% endif %}

        <div class="stats-section">
            <h2>统计概览</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <p class="stat-label">连续打卡天数</p>
                    <p class="stat-value">{{ stats.consecutive_days }}天</p>
                </div>
                <div class="stat-card">
                    <p class="stat-label">吃多了</p>
                    <p class="stat-value">{% if stats.eat_much_count is defined %}{{ stats.eat_much_count }}次 ({% if stats.eat_much_percent is defined %}{{ stats.eat_much_percent }}%{% else %}0%{% endif %}){% else %}0次 (0%){% endif %}</p>
                    <div class="progress-bar">
                        <div class="progress" style='width: {% if stats.eat_much_percent is defined %}{{ stats.eat_much_percent }}%{% else %}0%{% endif %}; background-color: #ff4444;'></div>
                    </div>
                </div>
                <div class="stat-card">
                    <p class="stat-label">没吃多</p>
                    <p class="stat-value">{% if stats.not_eat_much_count is defined %}{{ stats.not_eat_much_count }}次 ({% if stats.not_eat_much_percent is defined %}{{ stats.not_eat_much_percent }}%{% else %}0%{% endif %}){% else %}0次 (0%){% endif %}</p>
                    <div class="progress-bar">
                        <div class="progress" style='width: {% if stats.not_eat_much_percent is defined %}{{ stats.not_eat_much_percent }}%{% else %}0%{% endif %}; background-color: #4CAF50;'></div>
                    </div>
                </div>
                <div class="stat-card">
                    <p class="stat-label">总记录天数</p>
                    <p class="stat-value">{{ stats.total_days }}</p>
                </div>
                <div class="stat-card">
                    <p class="stat-label">平均热量缺口</p>
                    <p class="stat-value">{{ stats.avg_calorie_deficit }}千卡</p>
                    <div class="progress-bar">
                        <div class="progress" style='width: {{ stats.avg_calorie_deficit / 10 }}%; background-color: {% if stats.avg_calorie_deficit <= 500 %}hsl({{ 240 - (stats.avg_calorie_deficit / 500) * 120 }}, 100%, 50%){% else %}hsl({{ 120 - ((stats.avg_calorie_deficit - 500) / 500) * 120 }}, 100%, 50%){% endif %};'></div>
                    </div>
                </div>
            </div>
        </div>

    {% if today_food_record %}
    <div class="stats-section">
        <h2>今天的饮食</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <p class="stat-label">早餐</p>
                <p class="stat-value">{{ today_food_record.breakfast }}千卡</p>
                <div class="progress-bar">
                    <div class="progress" style='width: {{ today_food_record.breakfast / (stats.avg_breakfast_calories * 2) * 100 }}%; background-color: {% if stats.avg_breakfast_calories <= 500 %}hsl({{ 240 - (stats.avg_breakfast_calories / 500) * 120 }}, 100%, 50%){% else %}hsl({{ 120 - ((stats.avg_breakfast_calories - 500) / 500) * 120 }}, 100%, 50%){% endif %};'></div>
                </div>
            </div>
            <div class="stat-card">
                <p class="stat-label">午餐</p>
                <p class="stat-value">{{ today_food_record.lunch }}千卡</p>
                <div class="progress-bar">
                    <div class="progress" style='width: {{ today_food_record.lunch / (stats.avg_lunch_calories * 2) * 100 }}%; background-color: {% if stats.avg_lunch_calories <= 500 %}hsl({{ 240 - (stats.avg_lunch_calories / 500) * 120 }}, 100%, 50%){% else %}hsl({{ 120 - ((stats.avg_lunch_calories - 500) / 500) * 120 }}, 100%, 50%){% endif %};'></div>
                </div>
            </div>
            <div class="stat-card">
                <p class="stat-label">晚餐</p>
                <p class="stat-value">{{ today_food_record.dinner }}千卡</p>
                <div class="progress-bar">
                    <div class="progress" style='width: {{ today_food_record.dinner / (stats.avg_dinner_calories * 2) * 100 }}%; background-color: {% if stats.avg_dinner_calories <= 500 %}hsl({{ 240 - (stats.avg_dinner_calories / 500) * 120 }}, 100%, 50%){% else %}hsl({{ 120 - ((stats.avg_dinner_calories - 500) / 500) * 120 }}, 100%, 50%){% endif %};'></div>
                </div>
            </div>
            <div class="stat-card">
                <p class="stat-label">零食</p>
                <p class="stat-value">{{ today_food_record.snack }}千卡</p>
                <div class="progress-bar">
                    <div class="progress" style='width: {{ today_food_record.snack / (stats.avg_snack_calories * 2) * 100 }}%; background-color: {% if stats.avg_snack_calories <= 100 %}hsl({{ 240 - (stats.avg_snack_calories / 100) * 120 }}, 100%, 50%){% else %}hsl({{ 120 - ((stats.avg_snack_calories - 100) / 100) * 120 }}, 100%, 50%){% endif %};'></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="button-group">
        <button class="btn" style="background: #4CAF50 !important; color: white !important; border: none !important;" onclick="location.href='/u/{{ user.username }}/statistics'">统计总览</button>
    </div>
    <div class="button-group">
        <button class="btn" style="background: #9C27B0 !important; color: white !important; border: none !important;" onclick="location.href='/u/{{ user.username }}/charts'">图表可视化</button>
    </div>
    <div class="button-group">
        <button class="btn" style="background: #2196F3 !important; color: white !important; border: none !important;" onclick="location.href='/u/{{ user.username }}/setting'">个人设置</button>
    </div>
    <div class="button-group">
        <button class="btn" style="background: #FF9800 !important; color: white !important; border: none !important;" onclick="location.href='/u/{{ user.username }}/history'">历史记录</button>
    </div>

    </div>

    <script>
    async function submitAndRedirect(choice) {
        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: '{{ user.username }}', choice: choice})
            });
            if (response.ok) {
                location.href = '/u/{{ user.username }}/detail';
            }
        } catch (error) {
            console.error('提交失败:', error);
        }
    }

    async function submitRecord(choice) {
        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: '{{ user.username }}', choice: choice})
            });
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('提交失败:', error);
        }
    }
    </script>
</body>
</html>
